<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>自転車ルート比較＋自動休憩 (v6‑fixed)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
  /* ……（スタイルは前回と同じなので省略）…… */
</style>
</head>
<body>
<!-- ── UI：前回と同じ ───────────────────────── -->
<!-- 途中省略：controls / map / summary など UI 部分は v5 と同一 -->

<script>
/* === 定数 === */
const ORS_KEY  = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';                          // ←★あなたの ORS API キー
const ORS_ROOT = 'https://api.openrouteservice.org';
const POI_CATS = [451,443,624,518];           // convenience, drugstore, roadside, supermarket
const CAT_NAME = {451:'コンビニ',443:'ドラッグストア',624:'道の駅',518:'スーパー'};
const RADII    = [1000,2000,5000];

/* === ヘルパ === */
const $ = id=>document.getElementById(id);
const icon = c=>new L.Icon({iconUrl:`https://maps.gstatic.com/mapfiles/ms2/micons/${c}-dot.png`,
                            iconSize:[32,32],iconAnchor:[16,32]});
const ICONS={start:icon('green'),via:icon('blue'),goal:icon('red')};
const formatDist = d=>(d/1000).toFixed(2)+' km';
const formatDur  = s=>{const m=Math.round(s/60);return m<60?`${m} 分`:`${Math.floor(m/60)} 時間 ${m%60} 分`;};
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
const steepSum = f=>(f?.properties?.extras?.steepness?.values||[])
                     .reduce((s,e)=>s+Math.abs(e[2]||0),0);

/* === グローバル状態 === */
let pts=[], map, markerLayer, routeLayers={}, lastDir=0, poiCache=new Map();

/* === 汎用 POST（Directions など） === */
const post=(url,body)=>fetch(url,{method:'POST',
  headers:{'Content-Type':'application/json','Authorization':ORS_KEY},
  body:JSON.stringify(body)}).then(r=>r.ok?r.json():Promise.reject(r));

/* === Directions 用 === */
async function fetchRoute(body,profile){
  const delay=1100-(Date.now()-lastDir); if(delay>0) await sleep(delay);
  const res=await post(`${ORS_ROOT}/v2/directions/${profile}/geojson`,body);
  lastDir=Date.now(); return res;
}

/* === ★ POI 用：api_key=... を URL パラメータで渡す === */
async function pois(lat,lon,buf){
  const key=`${lat.toFixed(3)},${lon.toFixed(3)},${buf}`;
  if(poiCache.has(key)) return poiCache.get(key);
  await sleep(1100);                         // 1 req/s
  const body={
    request:'pois',
    geometry:{geojson:{type:'Point',coordinates:[lon,lat]},buffer:buf},
    filters:{category_ids:POI_CATS},
    limit:20
  };
  const url=`${ORS_ROOT}/pois?api_key=${ORS_KEY}`;      // ←ここがポイント
  const resp=await fetch(url,{method:'POST',
                              headers:{'Content-Type':'application/json'},
                              body:JSON.stringify(body)});
  if(!resp.ok){ console.warn('POI 取得失敗',await resp.text()); return {features:[]}; }
  const json=await resp.json();
  poiCache.set(key,json);
  return json;
}

/* === 休憩地点名の抽出 === */
const arr=x=>Array.isArray(x)?x:(x!=null?[x]:[]);
const pName=p=>{
  const t=p.properties?.osm_tags||{};
  return t['name:ja']||t.name||t.brand||t.operator||p.properties?.name||'';
};

/* === POI pick === */
async function nearPoi(lat,lon){
  for(const r of RADII){
    try{const d=await pois(lat,lon,r);
        if(d.features.length) return d.features[0];}catch{}
  }
  return null;
}

/* === makeRest === */
async function makeRest(feat,intS){
  const crd=feat.geometry.coordinates,segs=feat.properties.segments;
  let acc=0,res=[];
  for(const seg of segs){
    for(const st of seg.steps){
      acc+=st.duration;
      if(acc>=intS){
        const [lon,lat]=crd[st.way_points[1]],poi=await nearPoi(lat,lon);
        if(poi){
          const cat=POI_CATS.find(id=>arr(poi.properties.category_ids).includes(id));
          const display=pName(poi)||CAT_NAME[cat]||
                         poi.properties?.category||poi.properties?.osm_value||
                         '休憩地点';
          res.push({name:display,lat:poi.geometry.coordinates[1],
                    lon:poi.geometry.coordinates[0],isRest:true});
          acc=0;
        }
      }
    }
  }
  return res;
}

/* === --- 残りのコード（UI 操作／ルート描画など）は v5 と同じなので省略 --- */
/* === 以前の v5 から変更があるのは pois() と makeRest() だけです ============ */

</script>
</body>
</html>
