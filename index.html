<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>坂ルート案内アプリ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #map { height: 500px; }
    #controls { margin: 10px 0; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    #searchResults { max-height: 150px; overflow-y: auto; list-style: none; border: 1px solid #ccc; }
    #searchResults li:hover { background-color: #eee; cursor: pointer; }
    #pointList { list-style: none; padding-left: 0; }
    #pointList li { padding: 4px; border: 1px solid #ccc; margin-bottom: 4px; background: #fafafa; cursor: move; display: flex; justify-content: space-between; align-items: center; }
    #pointList li span.role-name { flex-grow: 1; }
    #distanceChartContainer { display: none; margin-top: 20px; background-color: #fff; padding: 10px; }
    #progressStatus { margin: 6px 0; color: #ff9900; font-weight: bold; min-height:1.5em; }
    .legend-steep { display:inline-block; border-radius:8px; padding:2px 10px; margin-right:10px; }
    .legend-blue { background:#6ab4ff; color:#003366;}
    .legend-red { background:#ffaaa2; color:#7a001b;}
  </style>
</head>

<body style="background-color: white;">
  <h2>坂ルート案内アプリ</h2>
  <div id="controls">
    <input id="placeInput" type="text" placeholder="地名・住所を入力" style="width: 240px;" />
    <button id="clearPlaceInputBtn">×</button>
    <button id="searchPlaceBtn">地名検索</button>
    <label><input type="checkbox" id="nearbyOnlyCheckbox" /> 近くの場所のみ検索</label>
    <button id="addCurrentBtn">現在地を追加</button>
    <button id="toggleRealTimeBtn">リアルタイム現在地更新 OFF</button>
    <button id="drawRouteBtn">坂ルート表示</button>
    <label style="display:flex; align-items:center; gap:4px;">
      <input type="checkbox" id="restCheckbox" />
      <input type="number" id="restDistanceInput" value="10" min="1" style="width:60px;" disabled /> kmで休憩 (コンビニ/スーパー/道の駅)
    </label>
    <button id="downloadCsvBtn">スコアCSVダウンロード</button>
    <button id="downloadGraphBtn">距離グラフダウンロード</button>
    <select id="profileSelect">
      <option value="foot-walking">徒歩</option>
      <option value="driving-car">車</option>
      <option value="cycling-regular">自転車（一般）</option>
      <option value="cycling-road" selected>ロードバイク</option>
      <option value="cycling-mountain">マウンテンバイク</option>
      <option value="cycling-electric">E-Bike</option>
    </select>
    <div id="routeInfo" style="margin-left:8px;"></div>
  </div>
  <div>
    <span class="legend-steep legend-blue">青：坂が少ないルート</span>
    <span class="legend-steep legend-red">赤：坂が多いルート</span>
  </div>
  <div id="progressStatus"></div>
  <h3>登録地点リスト（ドラッグで並び替え可能）</h3>
  <ul id="pointList"></ul>
  <ul id="searchResults"></ul>
  <div id="map"></div>
  <div id="distanceChartContainer">
    <canvas id="distanceChart" width="800" height="400" style="background-color: white;"></canvas>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/sortablejs@latest/Sortable.min.js"></script>
  <script>
    const apiKey = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9'; // ← OpenRouteService APIキーをここに
    const AUTO_REDRAW_DISTANCE = 50;
    const POI_SEARCH_RADIUS = 1000;
    const REST_POI_CATEGORIES = [533, 532, 414];

    const map = L.map('map').setView([35.681236, 139.767125], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

    const iconStart = new L.Icon({ iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',  iconSize:[32,32], iconAnchor:[16,32] });
    const iconVia   = new L.Icon({ iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',   iconSize:[32,32], iconAnchor:[16,32] });
    const iconEnd   = new L.Icon({ iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',    iconSize:[32,32], iconAnchor:[16,32] });
    const iconRest  = new L.Icon({ iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png', iconSize:[32,32], iconAnchor:[16,32] });

    const $ = id => document.getElementById(id);
    const placeInput = $('placeInput');
    const nearBox = $('nearbyOnlyCheckbox');
    const searchResults = $('searchResults');
    const restCheckbox = $('restCheckbox');
    const restDistanceInput = $('restDistanceInput');
    const pointList = $('pointList');
    const routeInfo = $('routeInfo');
    const progressStatus = $('progressStatus');
    const profileSelect = $('profileSelect');

    restCheckbox.addEventListener('change',()=>{restDistanceInput.disabled=!restCheckbox.checked;});

    let points=[], markers=[], restMarkers=[], routeLayers=[], currentRoute=null;
    let routeDistances=[], routeLabels=[];
    let watchId=null, realTimeMarker=null, lastLatLng=null;

    const toRad = d => d*Math.PI/180;
    const haversine = (lat1,lng1,lat2,lng2) => {
      const R=6371000;
      const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    };
    const clearLayers = arr => { arr.forEach(m=>map.removeLayer(m)); arr.length=0; };

    // --- 休憩地点処理・登録リスト関数は省略（前回のまま） ---

    // ルート取得＆坂ルート選定
    async function drawRouteWithSteep(){
      progressStatus.textContent = '';
      if(points.length<2){alert('出発地と目的地を含む2地点以上を登録してください');return;}
      const coords=points.map(p=>[p.lng,p.lat]);
      // alternative_routes
      const body = {
        coordinates: coords,
        alternative_routes: {share_factor: 0.6, target_count: 3}, // 最大3案
        extra_info: ["steepness"]
      };
      routeInfo.innerHTML = "ルート計算中…";
      const res=await fetch(`https://api.openrouteservice.org/v2/directions/${profileSelect.value}/geojson`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':apiKey},
        body:JSON.stringify(body)
      });
      if(!res.ok){alert('ルート取得エラー: '+res.status);return;}
      const data=await res.json();
      if(!data.features?.length){alert('ルート情報が取得できません');return;}

      // 勾配情報でルートを評価
      // steepness: {values: [ [start_idx, steepness_grade], ... ] }
      const routes = data.features.map((f,idx)=>{
        const steep = f.properties.extras.steepness?.values || [];
        let steepSum = 0;
        for(const s of steep){
          // grade: 0=平坦,1=0-3%,2=3-6%,3=6-10%,4=10-15%,5=15%+
          // 勾配強度を重み付け（例：grade番号の絶対値の合計）
          steepSum += Math.abs(s[1]);
        }
        return {feature:f, idx, steepSum, summary:f.properties.summary};
      });
      // 坂少＝steepSumが最小、坂多＝最大
      const best = routes.reduce((a,b)=>a.steepSum<=b.steepSum?a:b);
      const worst = routes.reduce((a,b)=>a.steepSum>=b.steepSum?a:b);

      // 地図上描画
      clearLayers(routeLayers);
      if(currentRoute) {map.removeLayer(currentRoute); currentRoute=null;}
      const bestLayer = L.geoJSON(best.feature, { style: { color: '#0095ff', weight: 6 } }).addTo(map);
      const worstLayer = L.geoJSON(worst.feature, { style: { color: '#ff1c1c', weight: 5, dashArray:'10 8' } }).addTo(map);
      routeLayers.push(bestLayer, worstLayer);

      map.fitBounds(bestLayer.getBounds());

      // サマリ表示
      routeInfo.innerHTML = `
        <b>坂が少ないルート</b>（青）距離: ${(best.summary.distance/1000).toFixed(2)}km / 時間: ${(best.summary.duration/60).toFixed(1)}分
        <br><b>坂が多いルート</b>（赤）距離: ${(worst.summary.distance/1000).toFixed(2)}km / 時間: ${(worst.summary.duration/60).toFixed(1)}分
        <br>勾配スコア（小さいほど坂が少ない）: <b>青 ${best.steepSum}</b> / <b>赤 ${worst.steepSum}</b>
      `;
    }

    // --- 以下は元の地名検索・リスト・追加ボタン等（省略） ---
    function addPoint(lat,lng,name=null){points.push({lat,lng,name}); updateMarkers(); refreshPointList();}
    function updateMarkers(){ clearLayers(markers); clearLayers(restMarkers);
      points.forEach((p,i)=>{
        let icon=iconVia;
        if(i===0) icon=iconStart;
        else if(i===points.length-1) icon=iconEnd;
        else if(p.name?.startsWith('休憩')) icon=iconRest;
        const mk=L.marker([p.lat,p.lng],{icon}).addTo(map).bindPopup(p.name||`(${p.lat.toFixed(5)},${p.lng.toFixed(5)})`);
        (icon===iconRest?restMarkers:markers).push(mk);
      });
    }
    function refreshPointList(){
      pointList.innerHTML='';
      points.forEach((p,i)=>{
        const li=document.createElement('li'); li.className='draggable';
        const span=document.createElement('span'); span.className='role-name';
        let prefix;
        if(p.name?.startsWith('休憩')){
          const match = p.name.match(/^休憩(\d+)/);
          prefix = match ? `休憩${match[1]}: ` : `休憩: `;
        }
        else if(i===0) prefix='出発地: ';
        else if(i===points.length-1) prefix='目的地: ';
        else prefix = `経由地${i}: `;
        span.textContent=prefix+(p.name?.replace(/^休憩\d+:\s?/, '') || `(${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})`);
        const btn=document.createElement('button'); btn.textContent='×'; btn.style.marginLeft='8px'; btn.onclick=()=>{points.splice(i,1);updateMarkers();refreshPointList();};
        li.appendChild(span); li.appendChild(btn); pointList.appendChild(li);
      });
    }
    new Sortable(pointList,{animation:150,onEnd:()=>{
      const arr=[]; Array.from(pointList.children).forEach(li=>{
        const txt=li.querySelector('span.role-name').textContent.replace(/^出発地:|^目的地:|^経由地\d+:|^休憩\d+: /,'').trim();
        const m=points.find(p=>{
          let baseName = p.name?.replace(/^休憩\d+:\s?/, '') || `(${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})`;
          return baseName === txt;
        });
        if(m) arr.push(m);
      }); points=arr; updateMarkers(); refreshPointList();
    }});
    function fetchPlaces(url){fetch(url).then(r=>r.json()).then(d=>{searchResults.innerHTML=''; if(!d.length){searchResults.textContent='該当なし';return;} d.forEach(p=>{const li=document.createElement('li'); li.textContent=p.display_name; li.onclick=()=>{addPoint(+p.lat,+p.lon,p.display_name); placeInput.value=''; searchResults.innerHTML='';}; searchResults.appendChild(li);});}).catch(e=>searchResults.textContent='検索エラー: '+e.message);}
    function fetchNearbyPlaces(q){let url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=10&addressdetails=1`; if(nearBox.checked && navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{const {latitude:lat,longitude:lon}=pos.coords;const d=0.05; url+=`&viewbox=${lon-d},${lat+d},${lon+d},${lat-d}&bounded=1`; fetchPlaces(url);});} else fetchPlaces(url);}
    $('searchPlaceBtn').onclick=()=>{const q=placeInput.value.trim(); if(q) fetchNearbyPlaces(q);};
    $('clearPlaceInputBtn').onclick=()=>{placeInput.value=''; searchResults.innerHTML='';};
    $('addCurrentBtn').onclick=()=>{if(!navigator.geolocation){alert('現在地取得未対応');return;} navigator.geolocation.getCurrentPosition(p=>addPoint(p.coords.latitude,p.coords.longitude,'現在地'));};
    $('toggleRealTimeBtn').onclick=()=>{
      const btn=$('toggleRealTimeBtn');
      if(watchId){navigator.geolocation.clearWatch(watchId); watchId=null; if(realTimeMarker) map.removeLayer(realTimeMarker); btn.textContent='リアルタイム現在地更新 OFF'; return;}
      if(!navigator.geolocation){alert('現在地取得未対応');return;}
      watchId=navigator.geolocation.watchPosition(pos=>{
        const {latitude,longitude}=pos.coords;
        if(!realTimeMarker){realTimeMarker=L.marker([latitude,longitude]).addTo(map).bindPopup('リアルタイム現在地'); addPoint(latitude,longitude,'リアルタイム現在地');}
        else realTimeMarker.setLatLng([latitude,longitude]);
        map.setView([latitude,longitude],14);
        if(lastLatLng){const d=haversine(lastLatLng.lat,lastLatLng.lng,latitude,longitude); if(d>=AUTO_REDRAW_DISTANCE) drawRouteWithSteep();}
        lastLatLng={lat:latitude, lng:longitude};
      },err=>alert('リアルタイム位置取得失敗: '+err.message),{enableHighAccuracy:true,maximumAge:1000,timeout:10000});
      btn.textContent='リアルタイム現在地更新 ON';
    };
    $('drawRouteBtn').onclick=()=>drawRouteWithSteep();
    // その他ダウンロード・グラフ・休憩自動生成は既存ロジックを流用してください
  </script>
</body>
</html>
