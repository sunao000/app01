<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>自転車ルート比較＋休憩（トリガ併用版） v5.9.1</title>

<!-- ライブラリ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script  src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script  src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script  src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui,sans-serif}
#map{height:500px;width:100%}
#controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
#pointList{list-style:none;margin:0;padding:0}
#pointList li{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
#searchResults{position:absolute;z-index:1000;width:260px;max-height:200px;overflow-y:auto;margin:4px 0 0;padding:0;list-style:none;border:1px solid #ccc;background:#fff}
#searchResults li{padding:4px 8px;cursor:pointer}
#searchResults li:hover{background:#e0e0e0}
#summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:0.9rem}
.section{padding:8px;background:#fff;border-top:1px solid #eee}
.group{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px}
.small{font-size:.88em;color:#555}
details{border:1px solid #ddd;border-radius:6px;padding:6px;background:#fff}
#charts{display:none}
#charts canvas{width:800px;height:400px}
hr{border:none;border-top:1px solid #eee;margin:8px 0}
label.chk{display:inline-flex;align-items:center;gap:6px;margin-right:10px}
input[type=number]{width:90px}
</style>
</head>
<body>

<!-- ────────── 上部操作 ────────── -->
<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:260px">
  <button id="searchBtn">検索</button>
  <label><input type="checkbox" id="nearbyOnly"> 近くの場所のみ</label>
  <button id="locBtn">現在地追加</button>

  <input id="restToggle" type="checkbox" checked hidden>
  <button id="restModeBtn">休憩込み: ON</button>

  <button id="btnDownloadTime"  disabled>PNG（時間×累積kJ）</button>
  <button id="btnDownloadDist"  disabled>PNG（距離×累積kJ）</button>

  <label>基準
    <select id="restBasis">
      <option value="time">時間</option>
      <option value="energy" selected>kJ</option>
    </select>
  </label>

  <span id="timeBox" class="group" style="display:none">
    <label>間隔 <input id="restMinutes" type="number" value="60" min="15" step="5"> 分</label>
  </span>
  <span id="energyBox" class="group">
    <label>しきい値 <input id="restKJ" type="number" value="500" min="100" step="50"> kJ</label>
    <button type="button" class="presetKJ" data-kj="400">400</button>
    <button type="button" class="presetKJ" data-kj="500">500</button>
    <button type="button" class="presetKJ" data-kj="650">650</button>
  </span>

  <select id="profileSelect">
    <option value="cycling-road" selected>ロードバイク</option>
    <option value="cycling-regular">自転車（一般）</option>
  </select>
  <button id="drawBtn">ルート表示</button>

  <label><input type="checkbox" id="chkShortest" checked> 最短</label>
  <label><input type="checkbox" id="chkFastest" checked> 最速</label>
  <label><input type="checkbox" id="chkSlope" checked> 勾配</label>
</div>

<!-- ────────── 休憩ロジック設定（簡素版） ────────── -->
<div class="section">
  <div class="group">
    <label>体重 <input id="riderWeight" type="number" value="65" min="30" max="150" step="0.5"> kg</label>
    <label>バイク重量 <input id="bikeWeight" type="number" value="10" min="5" max="30" step="0.1"> kg</label>
  </div>

  <details open><summary>積算トリガ（時間/kJ）</summary>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optAccum" checked> 積算トリガを使う</label>
      <span class="small">※ 上の「基準」と「しきい値/間隔」設定を使用</span>
    </div>
  </details>

  <!-- ▼ 統計トリガ（残す） -->
  <details open><summary>統計トリガ（平均と分散で休憩間隔をサンプリング）</summary>
    <div class="group">
      <label class="chk"><input type="checkbox" id="optStatTrigger"> 統計トリガを使う</label>
      <span class="small">※ ON時は下の平均/分散から各休憩ターゲットを逐次サンプル（基準の固定値は無視）</span>
    </div>
    <div class="group">
      <label>指標
        <select id="statMetric">
          <option value="distance" selected>走行距離（km）</option>
          <option value="energy">消費エネルギー（kJ）</option>
        </select>
      </label>
      <label>平均 <input id="statMean" type="number" value="20" min="0.1" step="0.1"> <span id="statMeanUnit">km</span></label>
      <label>分散 <input id="statVar" type="number" value="9" min="0" step="0.1"> <span id="statVarUnit">km²</span></label>
      <label>下限 <input id="statMin" type="number" value="5" min="0.1" step="0.1"> <span id="statMinUnit">km</span></label>
    </div>
    <div class="group">
      <label>乱数シード <input id="statSeed" type="number" value="12345" step="1"></label>
      <button type="button" id="statResampleBtn">次のターゲットを再サンプル</button>
    </div>
  </details>

  <!-- ※「入口/出口」「間引き」「スナップ」「安全装置」は完全削除 -->
  <details><summary>詳細設定（簡易エネルギーモデル）</summary>
    <div class="small">平坦係数 (kJ/km)</div>
    <label>平坦係数 <input id="flatKJperKm" type="number" value="18" min="10" max="30" step="0.5"> kJ/km</label>
  </details>
</div>

<ul id="searchResults" hidden></ul>
<ul id="pointList"></ul>
<div id="map"></div>

<div id="summary">
  <div id="routeInfo"></div>
  <div id="distanceScore" class="muted"></div>
</div>

<!-- デバッグ表示 -->
<div class="section">
  <details open>
    <summary>休憩トリガ・ヒット状況（TRIGGER/HIT）</summary>
    <div id="restDebug" class="small"></div>
  </details>
</div>

<!-- グラフ用オフスクリーン -->
<div id="charts">
  <canvas id="energyChart"></canvas>
</div>

<script>
/* ===== 定数 ===== */
const ORS_KEY  = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';  // ←★自分のキー
const ORS_ROOT = 'https://api.openrouteservice.org';

/* ===== ヘルパ ===== */
function $(id){return document.getElementById(id);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function icon(c){return new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/'+c+'-dot.png',iconSize:[32,32],iconAnchor:[16,32]});}
const ICONS = {start:icon('green'),via:icon('blue'),goal:icon('red')};
function formatDist(d){return (d/1000).toFixed(2)+' km';}
function formatDur(s){var m=Math.round(s/60);return m<60? m+' 分' : (Math.floor(m/60)+' 時間 '+(m%60)+' 分');}
function safe(path, fb){try{var v=path(); return (v===undefined||v===null)?fb:v;}catch(e){return fb;}}
function kmStr(m){ return (m/1000).toFixed(2) + ' km'; }

/* 乱数（シード付き） */
function mulberry32(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  };
}
function normal01(rng){
  let u = 0, v = 0;
  while(u === 0) u = rng();
  while(v === 0) v = rng();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2*Math.PI*v);
}
function sampleNormal(mean, variance, rng){
  const sd = Math.sqrt(Math.max(0, variance));
  return mean + sd * normal01(rng);
}

/* ===== 状態 ===== */
var pts=[], map, markerLayer, routeLayers={}, lastDirTs=0;
var lastFastest=null,lastMass=0,lastFlat=18;
var _statForceResampleFlag=false;

/* ===== 初期化 ===== */
window.addEventListener('DOMContentLoaded',function(){
  map=L.map('map').setView([34.07,134.55],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'©OpenStreetMap'}).addTo(map);
  map.createPane('routeSlope').style.zIndex=690;
  map.createPane('routeShortest').style.zIndex=700;
  map.createPane('routeFastest').style.zIndex=710;

  $('searchBtn').onclick   = function(){var q=$('placeInput').value.trim(); if(q) nomSearch(q);};
  $('locBtn').onclick      = addCurrent;
  $('drawBtn').onclick     = drawRoutes;

  $('btnDownloadTime').onclick = function(){downloadEnergyGraphByTime(lastFastest,lastMass,lastFlat);};
  $('btnDownloadDist').onclick = function(){downloadEnergyGraphByDistance(lastFastest,lastMass,lastFlat);};

  $('restModeBtn').onclick = function(){
    $('restToggle').checked=!$('restToggle').checked;
    $('restModeBtn').textContent='休憩込み: '+($('restToggle').checked?'ON':'OFF');
    drawRoutes();
  };
  $('restBasis').onchange  = function(e){
    var v=e.target.value;
    $('timeBox').style.display=(v==='time'?'inline-flex':'none');
    $('energyBox').style.display=(v==='energy'?'inline-flex':'none');
  };
  document.addEventListener('click',function(e){
    var b=e.target.closest?e.target.closest('.presetKJ'):null;
    if(b) $('restKJ').value=b.getAttribute('data-kj');
  });

  // 統計トリガ：単位表示
  $('statMetric').onchange = function(){
    const m = $('statMetric').value;
    if(m === 'distance'){
      $('statMeanUnit').textContent = 'km';
      $('statVarUnit').textContent  = 'km²';
      $('statMinUnit').textContent  = 'km';
    }else{
      $('statMeanUnit').textContent = 'kJ';
      $('statVarUnit').textContent  = 'kJ²';
      $('statMinUnit').textContent  = 'kJ';
    }
  };
  $('statResampleBtn').onclick = function(){
    _statForceResampleFlag = true;
    console.log('Stat trigger: will force resample next target.');
  };

  initSortable();
});

/* ===== 検索 ===== */
async function nomSearch(q){
  var url='https://nominatim.openstreetmap.org/search?format=json&limit=10&q='+encodeURIComponent(q);
  if($('nearbyOnly').checked){
    var b=map.getBounds();
    url+='&viewbox='+[b.getWest(),b.getNorth(),b.getEast(),b.getSouth()].join(',')+'&bounded=1';
  }
  var arr=await (await fetch(url)).json();
  var ul=$('searchResults'); ul.innerHTML=''; ul.hidden=!arr.length;
  arr.forEach(function(o){
    var li=document.createElement('li'); li.textContent=o.display_name;
    li.onclick=function(){addPoint({name:o.display_name,lat:+o.lat,lon:+o.lon});ul.hidden=true;$('placeInput').value='';};
    ul.appendChild(li);
  });
}

/* ===== リスト ===== */
function addPoint(p){p.type=pts.length?'':'start'; pts.forEach(function(d){if(d.type==='goal') d.type='via';}); pts.push(p); if(pts.length>1) pts[pts.length-1].type='goal'; drawList();}
function drawList(){
  var ul=$('pointList'); ul.innerHTML='';
  pts.forEach(function(p,i){
    var li=document.createElement('li'); li._idx=i;
    li.innerHTML='<span>'+p.name+(p.isRest?'（休憩）':'')+'</span>';
    var del=document.createElement('button'); del.className='del'; del.textContent='×';
    del.onclick=function(e){e.stopPropagation(); pts.splice(i,1); fixType(); drawList();};
    ul.appendChild(li); li.appendChild(del);
  });
}
function fixType(){ if(pts[0]) pts[0].type='start'; if(pts.length>1) pts[pts.length-1].type='goal'; }
function initSortable(){ new Sortable($('pointList'),{animation:150,handle:'span',onEnd:function(){pts=Array.prototype.slice.call($('pointList').children).map(function(li){return pts[li._idx];}); fixType(); drawList();}}); }

/* ===== 現在地 ===== */
function addCurrent(){navigator.geolocation.getCurrentPosition(function(p){addPoint({name:'現在地',lat:p.coords.latitude,lon:p.coords.longitude});},function(){alert('現在地取得失敗');});}

/* ===== ORS ===== */
async function post(url,body){
  var r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':ORS_KEY},body:JSON.stringify(body)});
  if(!r.ok) throw new Error(r.status); return r.json();
}
var lastDirTs=0;
async function dir(body,profile){
  var wait=1100-(Date.now()-lastDirTs); if(wait>0) await sleep(wait);
  var d=await post(ORS_ROOT+'/v2/directions/'+profile+'/geojson',body); lastDirTs=Date.now(); return d;
}

/* ===== エネルギー ===== */
function energyStepKJ(d,dz,m,flat){return flat*(d/1000)+Math.max(dz,0)*m*9.80665/1000;}

/* ===== 距離累積 ===== */
function buildCumDistArray(coords){
  var cd=[0];
  for(var i=1;i<coords.length;i++){
    var lon=coords[i][0], lat=coords[i][1], plon=coords[i-1][0], plat=coords[i-1][1];
    cd[i]=cd[i-1]+L.latLng(lat,lon).distanceTo([plat,plon]);
  }
  return cd;
}
function totalDist(cum){return cum[cum.length-1];}

/* ===== グラフ ===== */
function tempShowChartsContainer(show){
  var c=$('charts');
  if(show){c.style.display='block';c.style.position='absolute';c.style.left='-99999px';c.style.visibility='hidden';}
  else{c.removeAttribute('style');c.style.display='none';}
}
function prepareCanvasSize(canvas,w,h){canvas.width=w||1600;canvas.height=h||900;}
function buildEnergyTimeSeriesBySteps(feature,mass,flat){
  var coords=feature.geometry.coordinates, hasEle=(coords[0].length>=3);
  var cumT=0,cumE=0, tMin=[],eKJ=[];
  var segs=feature.properties.segments||[];
  for(var si=0;si<segs.length;si++){
    var steps=segs[si].steps||[];
    for(var st=0;st<steps.length;st++){
      var wp=steps[st].way_points||[0,0], i0=wp[0], i1=wp[1], d=steps[st].distance||0, dt=steps[st].duration||0;
      var dz=hasEle? ((coords[i1][2]||0)-(coords[i0][2]||0)) : 0;
      var dE=energyStepKJ(d,dz,m,flat);
      cumT+=dt; cumE+=dE; tMin.push((cumT/60).toFixed(2)); eKJ.push(+cumE.toFixed(1));
    }
  }
  return {labels:tMin,values:eKJ,xlabel:'時間 (分)',ylabel:'累積エネルギー (kJ)',filename:'energy_over_time.png'};
}
function buildEnergyDistanceSeriesBySteps(feature,mass,flat){
  var coords=feature.geometry.coordinates, hasEle=(coords[0].length>=3);
  var cumD=0,cumE=0, km=[],eKJ=[];
  var segs=feature.properties.segments||[];
  for(var si=0;si<segs.length;si++){
    var steps=segs[si].steps||[];
    for(var st=0;st<steps.length;st++){
      var wp=steps[st].way_points||[0,0], i0=wp[0], i1=wp[1], d=steps[st].distance||0;
      var dz=hasEle? ((coords[i1][2]||0)-(coords[i0][2]||0)) : 0;
      var dE=energyStepKJ(d,dz,m,flat);
      cumD+=d; cumE+=dE; km.push((cumD/1000).toFixed(2)); eKJ.push(+cumE.toFixed(1));
    }
  }
  return {labels:km,values:eKJ,xlabel:'距離 (km)',ylabel:'累積エネルギー (kJ)',filename:'energy_over_distance.png'};
}
function downloadLineChart(obj){
  tempShowChartsContainer(true);
  var ec = $('energyChart'); 
  prepareCanvasSize(ec,1600,900);

  var datasets = [{ label: obj.ylabel, data: obj.values, borderWidth: 2, pointRadius: 0 }];
  var scales = { x: { title: { display: true, text: obj.xlabel } }, y: { title: { display: true, text: obj.ylabel } } };
  var plugins = { legend: { display: false } };
  var cfg = { type:'line', data:{labels:obj.labels,datasets:datasets}, options:{animation:false,plugins:plugins,scales:scales} };

  var ch = new Chart(ec, cfg);
  setTimeout(function(){
    ec.toBlob(function(b){
      if(!b){ alert('PNG生成失敗'); return; }
      var u = URL.createObjectURL(b);
      var a = document.createElement('a');
      a.href = u;
      a.download = obj.filename;
      a.click();
      setTimeout(function(){
        URL.revokeObjectURL(u);
        ch.destroy();
        tempShowChartsContainer(false);
      }, 1000);
    }, 'image/png');
  }, 120);
}
function downloadEnergyGraphByTime(f,mass,flat){ if(!f){alert('先にルートを描画');return;} downloadLineChart(buildEnergyTimeSeriesBySteps(f,mass,flat)); }
function downloadEnergyGraphByDistance(f,mass,flat){ if(!f){alert('先にルートを描画');return;} downloadLineChart(buildEnergyDistanceSeriesBySteps(f,mass,flat)); }

/* ===== デバッグ出力 ===== */
function renderRestDebug(log){
  var el = $('restDebug');
  if(!el) return;
  if(!log || !log.length){
    el.innerHTML = '（なし）';
    return;
  }
  log.sort(function(a,b){
    if(a.at===b.at){ return (a.event||'').localeCompare(b.event||''); }
    return a.at - b.at;
  });
  var rows = log.map(function(r){
    var head = '[' + (r.kind||'') + '] ' + kmStr(r.at) + ' ';
    if(r.event==='TRIGGER'){
      var unit = '';
      if(r.metric==='distance') unit = 'km';
      else if(r.metric==='energy') unit = 'kJ';
      else if(r.metric==='sec') unit = 's';
      var tgt = (typeof r.target!=='undefined') ? (' target=' + (unit==='km' ? (+r.target).toFixed(2) : (+r.target).toFixed(1)) + unit) : '';
      return head + '→ TRIGGER' + tgt;
    }else if(r.event==='HIT'){
      return head + '→ HIT';
    }
    return head + '→ ' + (r.event||'');
  });
  el.innerHTML = '<pre style="margin:0; white-space:pre-wrap;">' + rows.join('\n') + '</pre>';
}

/* ===== 休憩ロジック：積算＆統計 併用 ===== */
// routeD（ルート距離[m]）で近接統合：同一点二重登録を防止
function mergeByRouteD(points, tolM){
  const tol = Math.max(1, Number(tolM)||20); // 20m以内なら同一とみなす
  points.sort((a,b)=>a.routeD-b.routeD);
  const out=[];
  for(const p of points){
    const last = out[out.length-1];
    if(last && Math.abs(last.routeD - p.routeD) <= tol){
      continue; // 近接は先着のみ保持
    }
    out.push(p);
  }
  return out;
}

async function makeRestSimple(previewFeature,basis,mass,flat,thr){
  const coords = previewFeature.geometry.coordinates;
  const segs   = safe(()=>previewFeature.properties.segments,[])||[];
  const hasEle = (coords[0].length>=3);
  const cum    = buildCumDistArray(coords);

  let debug = [];
  let rawPoints = []; // routeD を持つ内部候補（後で重複マージ）

  /* ====== 1) 統計トリガ ====== */
  if($('optStatTrigger').checked){
    const seed = Number($('statSeed').value) || 12345;
    const rng  = mulberry32(seed);
    const metric = $('statMetric').value; // 'distance' or 'energy'
    const mean = Number($('statMean').value) || 0;
    const vari = Math.max(0, Number($('statVar').value) || 0);
    const minV = Math.max(0.001, Number($('statMin').value) || 0.001);

    function drawTarget(){
      let t = sampleNormal(mean, vari, rng);
      if(!isFinite(t)) t = mean;
      return Math.max(minV, t);
    }
    let targetNext = drawTarget();
    let acc = 0;

    for(let si=0; si<segs.length; si++){
      const steps = segs[si].steps || [];
      for(let st=0; st<steps.length; st++){
        const wp = steps[st].way_points || [0,0];
        const i0 = wp[0], i1 = wp[1];
        const d  = steps[st].distance || 0;
        const dz = hasEle ? ((coords[i1][2]||0) - (coords[i0][2]||0)) : 0;
        const dE = energyStepKJ(d, dz, mass, flat);
        const dDkm = d/1000;

        acc += (metric==='distance') ? dDkm : dE;

        while(acc >= targetNext){
          const routeD = cum[i1];
          rawPoints.push({name:'休憩', lat:coords[i1][1], lon:coords[i1][0], routeD});
          debug.push({kind:(metric==='distance'?'ACCUM_DIST':'ACCUM_ENE'), at:routeD, event:'TRIGGER', target:targetNext, metric:metric});
          debug.push({kind:(metric==='distance'?'ACCUM_DIST':'ACCUM_ENE'), at:routeD, event:'HIT'});

          let nextT = drawTarget();
          if(_statForceResampleFlag){ nextT = drawTarget(); _statForceResampleFlag=false; }
          acc -= targetNext; // 余剰繰り越し
          targetNext = nextT;
        }
      }
    }
  }

  /* ====== 2) 積算トリガ（固定） ====== */
  if($('optAccum').checked){
    let acc = 0;
    for(let si=0; si<segs.length; si++){
      const steps = segs[si].steps || [];
      for(let st=0; st<steps.length; st++){
        const wp = steps[st].way_points || [0,0], i0=wp[0], i1=wp[1];
        const d = steps[st].distance || 0, t = steps[st].duration || 0;
        const dz = hasEle ? ((coords[i1][2]||0)-(coords[i0][2]||0)) : 0;
        const dE = energyStepKJ(d, dz, mass, flat);
        acc += (basis==='time') ? t : dE;
        if(acc >= thr){
          const routeD = cum[i1];
          rawPoints.push({name:'休憩', lat:coords[i1][1], lon:coords[i1][0], routeD});
          debug.push({kind:'ACCUM', at:routeD, event:'TRIGGER', target:thr, metric:(basis==='time'?'sec':'kJ')});
          debug.push({kind:'ACCUM', at:routeD, event:'HIT'});
          acc = 0;
        }
      }
    }
  }

  // 3) 近接マージ（20m既定）→ 表示・返却形式に整形
  const merged = mergeByRouteD(rawPoints, 20).map(p=>({
    name: p.name, lat: p.lat, lon: p.lon, type:'via', isRest:true
  }));

  window._restDebug = debug; // ログは併用分すべて残す（TRIGGER/HIT両方表示）
  return merged;
}

/* ===== ルート描画 ===== */
async function drawRoutes(){
  $('btnDownloadTime').disabled=true;
  $('btnDownloadDist').disabled=true;
  lastFastest=null;
  renderRestDebug([]); window._restDebug = [];

  if(pts.length<2){alert('2地点以上登録してください');return;}

  Object.keys(routeLayers).forEach(function(k){if(routeLayers[k]) map.removeLayer(routeLayers[k]);}); routeLayers={};
  if(markerLayer) map.removeLayer(markerLayer);

  // 以前の休憩を除去
  pts = pts.filter(function(p){return !p.isRest;});
  fixType(); drawList();

  var profile=$('profileSelect').value;
  var mass=Number($('riderWeight').value)+Number($('bikeWeight').value);
  var flat=Number($('flatKJperKm').value);
  var basis=$('restBasis').value;
  var thr=basis==='time' ? (Number($('restMinutes').value)*60) : Number($('restKJ').value);

  // 休憩プレビュー（トリガのみ）
  try{
    if($('restToggle').checked){
      var preview=await dir({coordinates:pts.map(function(p){return [p.lon,p.lat];}),elevation:true,extra_info:['steepness'],preference:'fastest'},profile);
      var feat=safe(function(){return preview.features[0];},null);
      if(feat){
        var rests=await makeRestSimple(feat,basis,mass,flat,thr);
        if(rests.length){
          var insertPos=Math.max(pts.length-1,1);
          Array.prototype.splice.apply(pts,[insertPos,0].concat(rests));
          fixType(); drawList();
        }
        if(typeof window._restDebug !== 'undefined'){ renderRestDebug(window._restDebug); }
      }
    }
  }catch(e){console.warn('休憩地点取得失敗',e);}

  // マーカー
  markerLayer=L.layerGroup().addTo(map);
  pts.forEach(function(p){
    var ic=p.type==='start'?ICONS.start:(p.type==='goal'?ICONS.goal:ICONS.via);
    markerLayer.addLayer(L.marker([p.lat,p.lon],{icon:ic}).bindTooltip(p.name+(p.isRest?'（休憩）':'')));
  });

  // ルート描画（最短/最速/勾配弱め）
  var coords=pts.map(function(p){return [p.lon,p.lat];});
  var base={coordinates:coords,elevation:true,extra_info:['steepness']};
  try{
    var shortest = await dir(Object.assign({},base,{preference:'shortest'}),profile);
    var fastest  = await dir(Object.assign({},base,{preference:'fastest'}),profile);
    var slope = shortest.features[0];
    if(coords.length===2){
      var alt=await dir(Object.assign({},base,{preference:'shortest',alternative_routes:{target_count:3,share_factor:0.6,weight_factor:1.4}}),profile);
      var feats=alt.features||[];
      if(feats.length){
        function steepSum(f){
          var vals=safe(function(){return f.properties.extras.steepness.values;},[]);
          var s=0; for(var i=0;i<vals.length;i++){ s+=Math.abs(vals[i][2]||0); } return s;
        }
        slope=feats.reduce(function(a,b){return steepSum(a)<steepSum(b)?a:b;});
      }
    }

    routeLayers.short=L.geoJSON(shortest.features[0],{pane:'routeShortest',style:{color:'#ff0000',weight:6}}).addTo(map);
    routeLayers.fast =L.geoJSON(fastest.features[0] ,{pane:'routeFastest', style:{color:'#0066ff',weight:6,dashArray:'4 4'}}).addTo(map);
    routeLayers.slope=L.geoJSON(slope               ,{pane:'routeSlope' , style:{color:'#ff9900',weight:6,opacity:0.9}}).addTo(map);
    updateLayerVisibility();

    var bounds=new L.LatLngBounds();
    markerLayer.eachLayer(function(l){bounds.extend(l.getLatLng());});
    Object.keys(routeLayers).forEach(function(k){bounds.extend(routeLayers[k].getBounds());});
    if(bounds.isValid()) map.fitBounds(bounds.pad(0.1));

    var s1=shortest.features[0].properties.summary, s2=fastest.features[0].properties.summary, s3=slope.properties.summary;
    $('routeInfo').innerHTML=
      '<b>最短</b> '+formatDist(s1.distance)+' / '+formatDur(s1.duration)+'<br>'+
      '<b>最速</b> '+formatDist(s2.distance)+' / '+formatDur(s2.duration)+'<br>'+
      '<b>勾配</b> '+formatDist(s3.distance)+' / '+formatDur(s3.duration);
    $('distanceScore').textContent='距離差: '+(s2.distance-s1.distance).toFixed(0)+' m';

    lastFastest=fastest.features[0]; lastMass=mass; lastFlat=flat;
    $('btnDownloadTime').disabled=false;
    $('btnDownloadDist').disabled=false;
  }catch(e){console.error(e);alert('ルート取得失敗: '+e.message);}
}
function updateLayerVisibility(){
  var m={short:'chkShortest',fast:'chkFastest',slope:'chkSlope'};
  Object.keys(routeLayers).forEach(function(k){
    if($(m[k]).checked) routeLayers[k].addTo(map); else map.removeLayer(routeLayers[k]);
  });
}
</script>
</body>
</html>
